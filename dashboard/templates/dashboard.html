<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê≥ Whale Follower Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap');
        body { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0d1f3c 100%); }
        .card { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .chart-container { height: 300px; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white" x-data="dashboard()">
    
    <!-- Header -->
    <header class="border-b border-white/10 p-4 sticky top-0 bg-black/50 backdrop-blur-xl z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <span class="text-4xl">üê≥</span>
                <div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent">Whale Follower</h1>
                    <p class="text-xs text-gray-400">NAD.FUN Smart Money Tracker | Monad Mainnet</p>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="text-right">
                    <p class="text-xs text-gray-400">Balance</p>
                    <p class="text-lg font-bold text-cyan-400" x-text="balance.toFixed(2) + ' MON'">0 MON</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full pulse"></span>
                    <span class="text-sm text-gray-400">Live</span>
                </div>
                <span class="text-xs text-gray-500" x-text="lastUpdate"></span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 space-y-6">
        
        <!-- Top Metrics Cards -->
        <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3">
            <div class="card rounded-xl p-4 hover:border-cyan-500/30 transition-all">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Positions</p>
                <p class="text-3xl font-bold text-white" x-text="metrics.open_positions">0</p>
            </div>
            <div class="card rounded-xl p-4 hover:border-green-500/30 transition-all">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Win Rate</p>
                <p class="text-3xl font-bold" :class="metrics.win_rate >= 50 ? 'text-green-400' : 'text-red-400'" 
                   x-text="metrics.win_rate.toFixed(0) + '%'">0%</p>
            </div>
            <div class="card rounded-xl p-4 hover:border-purple-500/30 transition-all">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Total Trades</p>
                <p class="text-3xl font-bold text-purple-400" x-text="metrics.total_trades">0</p>
            </div>
            <div class="card rounded-xl p-4 hover:border-yellow-500/30 transition-all">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Total P&L</p>
                <p class="text-3xl font-bold" :class="metrics.total_profit_mon >= 0 ? 'text-green-400' : 'text-red-400'"
                   x-text="(metrics.total_profit_mon >= 0 ? '+' : '') + metrics.total_profit_mon.toFixed(1)">0</p>
            </div>
            <div class="card rounded-xl p-4">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Wins</p>
                <p class="text-3xl font-bold text-green-400" x-text="metrics.winning_trades">0</p>
            </div>
            <div class="card rounded-xl p-4">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Losses</p>
                <p class="text-3xl font-bold text-red-400" x-text="metrics.losing_trades">0</p>
            </div>
            <div class="card rounded-xl p-4">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Avg Win</p>
                <p class="text-3xl font-bold text-green-400" x-text="'+' + metrics.avg_win.toFixed(1)">0</p>
            </div>
            <div class="card rounded-xl p-4">
                <p class="text-gray-500 text-xs uppercase tracking-wider">Open P&L</p>
                <p class="text-3xl font-bold" :class="metrics.open_pnl >= 0 ? 'text-green-400' : 'text-red-400'"
                   x-text="(metrics.open_pnl >= 0 ? '+' : '') + metrics.open_pnl.toFixed(1)">0</p>
            </div>
        </section>

        <!-- Charts Row -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Equity Curve -->
            <div class="card rounded-xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-white">üìà Equity Curve</h2>
                    <span class="text-xs text-gray-400">Portfolio Value Over Time</span>
                </div>
                <div id="equityChart" class="chart-container"></div>
            </div>
            
            <!-- P&L Distribution -->
            <div class="card rounded-xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-white">üí∞ Trade P&L</h2>
                    <span class="text-xs text-gray-400">Profit/Loss per Trade</span>
                </div>
                <div id="pnlChart" class="chart-container"></div>
            </div>
        </section>

        <!-- Open Positions Table -->
        <section class="card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-cyan-500/10 to-purple-500/10">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <span class="text-2xl">üìä</span> Open Positions
                </h2>
                <div class="flex items-center gap-4">
                    <span class="px-3 py-1 bg-cyan-500/20 rounded-full text-cyan-400 text-sm" x-text="positions.length + ' active'"></span>
                    <span class="text-sm text-gray-400" x-text="'Total: ' + totalInvested.toFixed(1) + ' MON'"></span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-white/5 text-xs text-gray-400 uppercase tracking-wider">
                        <tr>
                            <th class="p-4 text-left">Token</th>
                            <th class="p-4 text-right">Entry</th>
                            <th class="p-4 text-right">Current</th>
                            <th class="p-4 text-right">P&L</th>
                            <th class="p-4 text-right">%</th>
                            <th class="p-4 text-right">ATH</th>
                            <th class="p-4 text-center">Score</th>
                            <th class="p-4 text-center">üê≥ Whale</th>
                            <th class="p-4 text-right">Time</th>
                            <th class="p-4 text-center">TP Levels</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="pos in positions" :key="pos.token_address">
                            <tr class="border-t border-white/5 hover:bg-white/5 transition-all duration-200"
                                :class="pos.pnl_pct >= 30 ? 'bg-green-500/5' : pos.pnl_pct <= -10 ? 'bg-red-500/5' : ''">
                                <td class="p-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center text-lg">ü™ô</div>
                                        <div>
                                            <p class="font-medium text-white" x-text="pos.token_name"></p>
                                            <p class="text-xs text-gray-500 font-mono" x-text="pos.token_address.slice(0,10) + '...'"></p>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-4 text-right font-mono text-gray-300" x-text="pos.entry_mon.toFixed(1) + ' MON'"></td>
                                <td class="p-4 text-right font-mono text-white" x-text="pos.current_value_mon.toFixed(1) + ' MON'"></td>
                                <td class="p-4 text-right font-mono font-bold text-lg"
                                    :class="pos.pnl >= 0 ? 'text-green-400' : 'text-red-400'"
                                    x-text="(pos.pnl >= 0 ? '+' : '') + pos.pnl.toFixed(2)"></td>
                                <td class="p-4 text-right">
                                    <span class="px-2 py-1 rounded-lg font-bold"
                                          :class="pos.pnl_pct >= 50 ? 'bg-green-500/30 text-green-300' : pos.pnl_pct >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                                          x-text="(pos.pnl_pct >= 0 ? '+' : '') + pos.pnl_pct.toFixed(1) + '%'"></span>
                                </td>
                                <td class="p-4 text-right font-mono text-yellow-400" x-text="pos.highest_value_mon.toFixed(1)"></td>
                                <td class="p-4 text-center">
                                    <span class="px-3 py-1 rounded-full text-sm font-bold"
                                          :class="pos.score >= 70 ? 'bg-green-500/30 text-green-300' : pos.score >= 55 ? 'bg-yellow-500/30 text-yellow-300' : 'bg-red-500/30 text-red-300'"
                                          x-text="pos.score"></span>
                                </td>
                                <td class="p-4 text-center">
                                    <span class="font-mono text-cyan-400 font-bold" x-text="pos.whale_buy_mon.toFixed(0)"></span>
                                    <span class="text-gray-500 text-xs">MON</span>
                                </td>
                                <td class="p-4 text-right text-gray-400 text-sm" x-text="pos.time_held"></td>
                                <td class="p-4 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                                              :class="pos.tp_level_1_taken ? 'bg-green-500 text-white' : 'bg-gray-700 text-gray-500'">1</span>
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                                              :class="pos.tp_level_2_taken ? 'bg-green-500 text-white' : 'bg-gray-700 text-gray-500'">2</span>
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                                              :class="pos.tp_level_3_taken ? 'bg-green-500 text-white' : 'bg-gray-700 text-gray-500'">3</span>
                                        <span x-show="pos.moonbag_secured" class="text-yellow-400 text-lg ml-1">üåô</span>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="positions.length === 0">
                            <td colspan="10" class="p-12 text-center text-gray-500">
                                <span class="text-4xl">üê≥</span>
                                <p class="mt-2">No open positions. Waiting for whale buys...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Trade History -->
        <section class="card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-purple-500/10 to-pink-500/10">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <span class="text-2xl">üìú</span> Trade History
                </h2>
                <span class="px-3 py-1 bg-purple-500/20 rounded-full text-purple-400 text-sm" x-text="trades.length + ' trades'"></span>
            </div>
            <div class="overflow-x-auto max-h-80">
                <table class="w-full">
                    <thead class="bg-white/5 text-xs text-gray-400 uppercase tracking-wider sticky top-0">
                        <tr>
                            <th class="p-3 text-left">Token</th>
                            <th class="p-3 text-right">Entry</th>
                            <th class="p-3 text-right">Exit</th>
                            <th class="p-3 text-right">P&L</th>
                            <th class="p-3 text-right">%</th>
                            <th class="p-3 text-left">Reason</th>
                            <th class="p-3 text-right">Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="trade in trades" :key="trade.timestamp">
                            <tr class="border-t border-white/5 hover:bg-white/5">
                                <td class="p-3 font-medium" x-text="trade.token_name || trade.token_address?.slice(0,12)"></td>
                                <td class="p-3 text-right font-mono text-gray-300" x-text="(trade.entry_mon || 0).toFixed(1)"></td>
                                <td class="p-3 text-right font-mono text-white" x-text="(trade.exit_mon || 0).toFixed(1)"></td>
                                <td class="p-3 text-right font-mono font-bold"
                                    :class="trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'"
                                    x-text="(trade.pnl >= 0 ? '+' : '') + (trade.pnl || 0).toFixed(2)"></td>
                                <td class="p-3 text-right">
                                    <span class="px-2 py-1 rounded text-sm"
                                          :class="trade.pnl_pct >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                                          x-text="(trade.pnl_pct >= 0 ? '+' : '') + (trade.pnl_pct || 0).toFixed(1) + '%'"></span>
                                </td>
                                <td class="p-3 text-gray-400 text-sm" x-text="trade.reason || '-'"></td>
                                <td class="p-3 text-right text-gray-500 text-xs" x-text="formatTime(trade.timestamp)"></td>
                            </tr>
                        </template>
                        <tr x-show="trades.length === 0">
                            <td colspan="7" class="p-8 text-center text-gray-500">
                                No closed trades yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Bot Status -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="card rounded-xl p-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üê≥</span>
                    <div>
                        <p class="text-gray-400 text-sm">Whale Follower</p>
                        <p class="text-green-400 font-bold">Active ‚Ä¢ 25 MON base</p>
                    </div>
                </div>
            </div>
            <div class="card rounded-xl p-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üìä</span>
                    <div>
                        <p class="text-gray-400 text-sm">Position Manager</p>
                        <p class="text-green-400 font-bold">Active ‚Ä¢ Trailing Stops</p>
                    </div>
                </div>
            </div>
            <div class="card rounded-xl p-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ü§ñ</span>
                    <div>
                        <p class="text-gray-400 text-sm">AI Strategy Agent</p>
                        <p class="text-cyan-400 font-bold">DeepSeek ‚Ä¢ 5min cycle</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Real-time Logs Panel -->
        <section class="card rounded-xl overflow-hidden" x-data="logsPanel()" x-init="init()">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-emerald-500/10 to-cyan-500/10">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <span class="text-2xl">üìú</span> Live Logs
                </h2>
                <div class="flex items-center gap-3">
                    <!-- Bot selector tabs -->
                    <div class="flex bg-black/30 rounded-lg p-1">
                        <button @click="switchBot('whale_follower')" 
                                :class="currentBot === 'whale_follower' ? 'bg-cyan-500/30 text-cyan-400' : 'text-gray-400 hover:text-white'"
                                class="px-3 py-1 rounded text-sm font-medium transition-all">
                            üê≥ Whale
                        </button>
                        <button @click="switchBot('position_manager')" 
                                :class="currentBot === 'position_manager' ? 'bg-purple-500/30 text-purple-400' : 'text-gray-400 hover:text-white'"
                                class="px-3 py-1 rounded text-sm font-medium transition-all">
                            üìä PM
                        </button>
                        <button @click="switchBot('take_profits')" 
                                :class="currentBot === 'take_profits' ? 'bg-green-500/30 text-green-400' : 'text-gray-400 hover:text-white'"
                                class="px-3 py-1 rounded text-sm font-medium transition-all">
                            üí∞ TP
                        </button>
                    </div>
                    <!-- Live indicator -->
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full" :class="streaming ? 'pulse' : ''"></span>
                        <span class="text-xs text-gray-400" x-text="streaming ? 'Live' : 'Paused'"></span>
                    </div>
                    <!-- Controls -->
                    <button @click="toggleStream()" 
                            :class="streaming ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'"
                            class="px-3 py-1 rounded text-sm hover:opacity-80 transition-all">
                        <span x-text="streaming ? '‚è∏ Pause' : '‚ñ∂ Resume'"></span>
                    </button>
                    <button @click="clearLogs()" class="px-3 py-1 bg-gray-500/20 text-gray-400 rounded text-sm hover:bg-gray-500/30">
                        üóë Clear
                    </button>
                </div>
            </div>
            
            <!-- Log filters -->
            <div class="px-4 py-2 border-b border-white/5 flex gap-2 flex-wrap">
                <button @click="toggleFilter('all')" 
                        :class="activeFilters.includes('all') ? 'bg-white/20 text-white' : 'bg-white/5 text-gray-400'"
                        class="px-2 py-1 rounded text-xs hover:bg-white/10 transition-all">All</button>
                <button @click="toggleFilter('whale')" 
                        :class="activeFilters.includes('whale') ? 'bg-cyan-500/30 text-cyan-400' : 'bg-white/5 text-gray-400'"
                        class="px-2 py-1 rounded text-xs hover:bg-white/10 transition-all">üê≥ Whale</button>
                <button @click="toggleFilter('success')" 
                        :class="activeFilters.includes('success') ? 'bg-green-500/30 text-green-400' : 'bg-white/5 text-gray-400'"
                        class="px-2 py-1 rounded text-xs hover:bg-white/10 transition-all">‚úÖ Success</button>
                <button @click="toggleFilter('error')" 
                        :class="activeFilters.includes('error') ? 'bg-red-500/30 text-red-400' : 'bg-white/5 text-gray-400'"
                        class="px-2 py-1 rounded text-xs hover:bg-white/10 transition-all">‚ùå Errors</button>
                <button @click="toggleFilter('warning')" 
                        :class="activeFilters.includes('warning') ? 'bg-yellow-500/30 text-yellow-400' : 'bg-white/5 text-gray-400'"
                        class="px-2 py-1 rounded text-xs hover:bg-white/10 transition-all">‚ö†Ô∏è Warnings</button>
                <button @click="toggleFilter('stats')" 
                        :class="activeFilters.includes('stats') ? 'bg-purple-500/30 text-purple-400' : 'bg-white/5 text-gray-400'"
                        class="px-2 py-1 rounded text-xs hover:bg-white/10 transition-all">üìä Stats</button>
            </div>
            
            <!-- Log output -->
            <div id="logContainer" class="h-96 overflow-y-auto bg-black/30 font-mono text-sm p-4 space-y-1" 
                 x-ref="logContainer">
                <template x-for="(log, index) in filteredLogs" :key="index">
                    <div class="flex gap-2 py-1 border-b border-white/5 hover:bg-white/5 transition-all"
                         :class="{
                             'bg-green-500/5': log.type === 'success',
                             'bg-red-500/5': log.type === 'error',
                             'bg-yellow-500/5': log.type === 'warning',
                             'bg-cyan-500/5': log.type === 'whale'
                         }">
                        <span class="text-gray-500 text-xs w-20 flex-shrink-0" x-text="formatLogTime(log.timestamp)"></span>
                        <span class="w-12 flex-shrink-0 text-center"
                              :class="{
                                  'text-green-400': log.level === 'INFO' && log.type === 'success',
                                  'text-red-400': log.level === 'ERROR' || log.type === 'error',
                                  'text-yellow-400': log.level === 'WARN' || log.type === 'warning',
                                  'text-cyan-400': log.type === 'whale',
                                  'text-gray-400': log.type === 'info'
                              }"
                              x-text="log.level"></span>
                        <span class="text-gray-300 flex-1 break-all" x-text="log.message"></span>
                    </div>
                </template>
                <div x-show="filteredLogs.length === 0" class="text-center text-gray-500 py-8">
                    <span class="text-4xl">üìú</span>
                    <p class="mt-2">No logs matching filters. Waiting for activity...</p>
                </div>
            </div>
            
            <!-- Log stats bar -->
            <div class="px-4 py-2 border-t border-white/10 flex justify-between items-center text-xs text-gray-500 bg-black/20">
                <span x-text="'Showing ' + filteredLogs.length + ' of ' + logs.length + ' logs'"></span>
                <span x-text="'Bot: ' + currentBot.replace('_', ' ').toUpperCase()"></span>
            </div>
        </section>

    </main>

    <footer class="border-t border-white/10 p-6 mt-8">
        <div class="container mx-auto text-center text-gray-500 text-sm">
            <p>üê≥ Whale Follower v2.0 | NAD.FUN on Monad Mainnet | Powered by DeepSeek AI</p>
        </div>
    </footer>

    <script>
        let equityChart, pnlChart;
        
        // Logs Panel Component
        function logsPanel() {
            return {
                logs: [],
                currentBot: 'whale_follower',
                streaming: true,
                eventSource: null,
                activeFilters: ['all'],
                maxLogs: 200,
                
                get filteredLogs() {
                    if (this.activeFilters.includes('all')) {
                        return this.logs;
                    }
                    return this.logs.filter(log => this.activeFilters.includes(log.type));
                },
                
                async init() {
                    await this.loadInitialLogs();
                    this.startStream();
                },
                
                async loadInitialLogs() {
                    try {
                        const res = await fetch(`/api/logs/${this.currentBot}?lines=100`);
                        const logs = await res.json();
                        this.logs = logs.reverse(); // Oldest first, newest at bottom
                        this.$nextTick(() => this.scrollToBottom());
                    } catch (e) {
                        console.error('Failed to load logs:', e);
                    }
                },
                
                startStream() {
                    if (this.eventSource) {
                        this.eventSource.close();
                    }
                    
                    this.eventSource = new EventSource(`/api/logs/stream/${this.currentBot}`);
                    this.streaming = true;
                    
                    this.eventSource.onmessage = (event) => {
                        const log = JSON.parse(event.data);
                        this.logs.push(log);
                        
                        // Trim to max logs
                        if (this.logs.length > this.maxLogs) {
                            this.logs = this.logs.slice(-this.maxLogs);
                        }
                        
                        this.$nextTick(() => this.scrollToBottom());
                    };
                    
                    this.eventSource.onerror = () => {
                        console.log('SSE connection lost, reconnecting...');
                        this.streaming = false;
                        setTimeout(() => {
                            if (!this.streaming) this.startStream();
                        }, 3000);
                    };
                },
                
                stopStream() {
                    if (this.eventSource) {
                        this.eventSource.close();
                        this.eventSource = null;
                    }
                    this.streaming = false;
                },
                
                toggleStream() {
                    if (this.streaming) {
                        this.stopStream();
                    } else {
                        this.startStream();
                    }
                },
                
                async switchBot(botName) {
                    this.currentBot = botName;
                    this.logs = [];
                    this.stopStream();
                    await this.loadInitialLogs();
                    this.startStream();
                },
                
                toggleFilter(filter) {
                    if (filter === 'all') {
                        this.activeFilters = ['all'];
                    } else {
                        // Remove 'all' if specific filter selected
                        this.activeFilters = this.activeFilters.filter(f => f !== 'all');
                        
                        if (this.activeFilters.includes(filter)) {
                            this.activeFilters = this.activeFilters.filter(f => f !== filter);
                        } else {
                            this.activeFilters.push(filter);
                        }
                        
                        // If no filters, default to 'all'
                        if (this.activeFilters.length === 0) {
                            this.activeFilters = ['all'];
                        }
                    }
                },
                
                clearLogs() {
                    this.logs = [];
                },
                
                scrollToBottom() {
                    const container = this.$refs.logContainer;
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                },
                
                formatLogTime(timestamp) {
                    if (!timestamp) return '--:--:--';
                    try {
                        const date = new Date(timestamp);
                        return date.toLocaleTimeString('en-GB');
                    } catch {
                        return timestamp.split('T')[1]?.split('.')[0] || '--:--:--';
                    }
                }
            }
        }
        
        function dashboard() {
            return {
                positions: [],
                trades: [],
                metrics: { total_trades: 0, winning_trades: 0, losing_trades: 0, win_rate: 0, total_profit_mon: 0, open_positions: 0, open_pnl: 0, avg_win: 0, avg_loss: 0 },
                balance: 1538,
                lastUpdate: 'Loading...',
                
                get totalInvested() {
                    return this.positions.reduce((sum, p) => sum + p.entry_mon, 0);
                },
                
                async init() {
                    this.initCharts();
                    await this.refresh();
                    setInterval(() => this.refresh(), 5000);
                },
                
                initCharts() {
                    const equityContainer = document.getElementById('equityChart');
                    equityChart = LightweightCharts.createChart(equityContainer, {
                        layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#9ca3af' },
                        grid: { vertLines: { color: 'rgba(255,255,255,0.05)' }, horzLines: { color: 'rgba(255,255,255,0.05)' } },
                        width: equityContainer.clientWidth, height: 280,
                        rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
                        timeScale: { borderColor: 'rgba(255,255,255,0.1)', timeVisible: true },
                    });
                    this.equitySeries = equityChart.addAreaSeries({
                        lineColor: '#06b6d4', topColor: 'rgba(6, 182, 212, 0.4)', bottomColor: 'rgba(6, 182, 212, 0.0)', lineWidth: 2,
                    });
                    
                    const pnlContainer = document.getElementById('pnlChart');
                    pnlChart = LightweightCharts.createChart(pnlContainer, {
                        layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#9ca3af' },
                        grid: { vertLines: { color: 'rgba(255,255,255,0.05)' }, horzLines: { color: 'rgba(255,255,255,0.05)' } },
                        width: pnlContainer.clientWidth, height: 280,
                    });
                    this.pnlSeries = pnlChart.addHistogramSeries({ color: '#22c55e' });
                    
                    window.addEventListener('resize', () => {
                        equityChart.applyOptions({ width: equityContainer.clientWidth });
                        pnlChart.applyOptions({ width: pnlContainer.clientWidth });
                    });
                },
                
                async refresh() {
                    try {
                        const [posRes, tradesRes, metricsRes] = await Promise.all([
                            fetch('/api/positions'), fetch('/api/trades'), fetch('/api/metrics')
                        ]);
                        this.positions = await posRes.json();
                        this.trades = await tradesRes.json();
                        this.metrics = await metricsRes.json();
                        this.lastUpdate = new Date().toLocaleTimeString();
                        
                        const openPnl = this.positions.reduce((s, p) => s + (p.pnl || 0), 0);
                        this.balance = 1538 + this.metrics.total_profit_mon + openPnl;
                        this.updateCharts();
                    } catch (e) { console.error('Refresh error:', e); }
                },
                
                updateCharts() {
                    let balance = 1000;
                    const equityData = [], pnlData = [];
                    const sortedTrades = [...this.trades].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    
                    sortedTrades.forEach((trade, i) => {
                        balance += (trade.pnl || 0);
                        const time = trade.timestamp || (Date.now()/1000 - (sortedTrades.length - i) * 3600);
                        equityData.push({ time: Math.floor(time), value: balance });
                        pnlData.push({ time: Math.floor(time), value: trade.pnl || 0, color: (trade.pnl || 0) >= 0 ? '#22c55e' : '#ef4444' });
                    });
                    
                    if (equityData.length === 0) {
                        const now = Math.floor(Date.now() / 1000);
                        equityData.push({ time: now - 3600, value: 1000 });
                        equityData.push({ time: now, value: this.balance || 1538 });
                    }
                    
                    if (equityData.length > 0) this.equitySeries.setData(equityData);
                    if (pnlData.length > 0) this.pnlSeries.setData(pnlData);
                },
                
                formatTime(timestamp) {
                    if (!timestamp) return '-';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5);
                }
            }
        }
    </script>
</body>
</html>
